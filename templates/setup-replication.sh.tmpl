#!/bin/sh

psql -U postgres -v ON_ERROR_STOP=1 <<-EOF
ALTER SYSTEM SET wal_level = hot_standby;
ALTER SYSTEM SET max_wal_senders = 16;
ALTER SYSTEM SET max_replication_slots = 10;
ALTER SYSTEM SET wal_keep_segments = 32;
ALTER SYSTEM SET hot_standby = on;
EOF

echo host replication all 0.0.0.0/0 trust >> /var/lib/postgresql/data/pg_hba.conf

{{if exists "/self/service/containers/1/uuid"}}
# replica

until pg_isready -h lb
do
  echo "Sleep 1s and try again..."
  sleep 1
done

echo "Stopping PostgreSQL..."
gosu postgres pg_ctl -D "$PGDATA" -m fast -w stop

echo "Removing data dir..."
rm -rf $PGDATA/*

echo "Launching pg_basebackup..."
gosu postgres pg_basebackup -h lb -R -D $PGDATA -U postgres -v -P --xlog-method=stream -w

echo "Create physical_replication_slot on server..."
psql -h lb -c "SELECT * FROM pg_create_physical_replication_slot('${HOSTNAME}');" -U postgres -d postgres

cat >> ${PGDATA}/recovery.conf <<-EOF
primary_slot_name = '${HOSTNAME}'
recovery_target_timeline = 'latest'
EOF

echo "Starting PostgreSQL..."
gosu postgres pg_ctl -D "$PGDATA" -w start

{{else}}
# master
{{end}}
